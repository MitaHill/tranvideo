# ç³»ç»Ÿæ¶æ„æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» Tranvideo çš„ç³»ç»Ÿæ¶æ„è®¾è®¡å’Œæ ¸å¿ƒæŠ€æœ¯å®ç°ã€‚

## ç›®å½•

- [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [å¤„ç†æµç¨‹](#å¤„ç†æµç¨‹)
- [æ•°æ®æµ](#æ•°æ®æµ)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [è®¾è®¡æ¨¡å¼](#è®¾è®¡æ¨¡å¼)

---

## æ¶æ„æ€»è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Web æµè§ˆå™¨  â”‚  HTTP å®¢æˆ·ç«¯    â”‚  Python/JS SDK               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API ç½‘å…³å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Flask Router  â”‚  å®‰å…¨æ¨¡å—  â”‚  è¯·æ±‚éªŒè¯  â”‚  é€Ÿç‡é™åˆ¶        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸šåŠ¡é€»è¾‘å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»»åŠ¡ç®¡ç†å™¨    â”‚  æ‰¹æ¬¡ç®¡ç†å™¨    â”‚  åè°ƒå™¨       â”‚ è¿›åº¦è·Ÿè¸ªå™¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æœåŠ¡å±‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Whisper æœåŠ¡  â”‚  ç¿»è¯‘æœåŠ¡     â”‚  è§†é¢‘å¤„ç†æœåŠ¡   â”‚ æ–‡ä»¶æœåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€è®¾æ–½å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VRAM ç®¡ç†å™¨  â”‚  é˜Ÿåˆ—ç®¡ç†å™¨     â”‚  æ•°æ®åº“      â”‚  æ–‡ä»¶ç³»ç»Ÿ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¤–éƒ¨ä¾èµ–                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Whisper    â”‚    Ollama    â”‚   FFmpeg     â”‚   PyTorch      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Host                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Tranvideo      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Ollama Container  â”‚     â”‚
â”‚  â”‚  Container      â”‚         â”‚  Port: 11434       â”‚     â”‚
â”‚  â”‚  Port: 5000     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚         â”‚                                                 â”‚
â”‚         â”‚                                                 â”‚
â”‚         â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚         Shared Volumes                      â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚  cache/           â”‚  db/        â”‚  logs/    â”‚         â”‚
â”‚  â”‚  â”œâ”€ uploads/      â”‚  â””â”€tasks.jsonâ”‚          â”‚         â”‚
â”‚  â”‚  â”œâ”€ temp/         â”‚              â”‚          â”‚         â”‚
â”‚  â”‚  â””â”€ outputs/      â”‚              â”‚          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚         NVIDIA GPU (CUDA)                â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚            â”‚
â”‚  â”‚  â”‚  Whisper   â”‚â—„â”€â”€â”€â”€â–ºâ”‚   Ollama   â”‚      â”‚            â”‚
â”‚  â”‚  â”‚  Model     â”‚ VRAM â”‚   Model    â”‚      â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Swap â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. API å±‚ (src/api/)

**èŒè´£**: å¤„ç† HTTP è¯·æ±‚ï¼Œè·¯ç”±åˆ†å‘

**ä¸»è¦æ–‡ä»¶**:
- `__init__.py` - è·¯ç”±å®šä¹‰
- `handlers.py` - è¯·æ±‚å¤„ç†å™¨
- `security.py` - å®‰å…¨ç®¡ç†å™¨

**å…³é”®åŠŸèƒ½**:

```python
# è·¯ç”±å®šä¹‰
@app.route('/api/process/srt/<invite_code>', methods=['POST'])
def process_srt(invite_code):
    # 1. éªŒè¯é‚€è¯·ç 
    # 2. éªŒè¯æ–‡ä»¶
    # 3. åˆ›å»ºä»»åŠ¡
    # 4. è¿”å›ä»»åŠ¡ID
```

### 2. æ ¸å¿ƒä¸šåŠ¡å±‚ (src/core/)

#### ä»»åŠ¡ç®¡ç†å™¨ (task.py)

**èŒè´£**: å•ä»»åŠ¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
class TaskProcessor:
    def process(self, task_id):
        # 1. æå–éŸ³é¢‘
        audio = self.extract_audio(video_path)

        # 2. è¯­éŸ³è¯†åˆ«
        srt = self.transcribe(audio)

        # 3. ç¿»è¯‘
        translated_srt = self.translate(srt)

        # 4. ç”Ÿæˆå­—å¹•æ–‡ä»¶
        self.generate_subtitles()

        # 5. è§†é¢‘åˆæˆï¼ˆå¯é€‰ï¼‰
        if mode == 'video':
            self.merge_video(srt)
```

#### æ‰¹æ¬¡ç®¡ç†å™¨ (batch.py)

**èŒè´£**: æ‰¹é‡ä»»åŠ¡çš„åè°ƒå’Œç®¡ç†

```python
class BatchManager:
    def create_batch(self, files, mode):
        # 1. åˆ›å»ºæ‰¹æ¬¡è®°å½•
        batch_id = generate_batch_id()

        # 2. ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºå­ä»»åŠ¡
        for file in files:
            task_id = create_task(file, batch_id, mode)
            tasks.append(task_id)

        # 3. è¿”å›æ‰¹æ¬¡ä¿¡æ¯
        return batch_id, tasks
```

#### ä»»åŠ¡åè°ƒå™¨ (coordinate.py)

**èŒè´£**: ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å’Œè°ƒåº¦

```python
class TaskCoordinator:
    def __init__(self):
        self.queue = Queue()
        self.current_task = None

    def add_task(self, task_id):
        self.queue.put(task_id)

    def process_queue(self):
        while True:
            task_id = self.queue.get()
            self.process_task(task_id)
```

### 3. æœåŠ¡å±‚ (src/services/)

#### Whisper æœåŠ¡ (use_whisper.py)

**èŒè´£**: è¯­éŸ³è¯†åˆ«æœåŠ¡å°è£…

```python
class WhisperService:
    def __init__(self):
        self.model = whisper.load_model(
            "large-v3-turbo",
            device="cuda"
        )

    def transcribe(self, audio_path):
        result = self.model.transcribe(
            audio_path,
            language="auto",
            task="transcribe"
        )
        return result
```

#### ç¿»è¯‘æœåŠ¡ (tran.py)

**èŒè´£**: å¤šåç«¯ç¿»è¯‘æœåŠ¡

```python
class TranslationService:
    def translate(self, text, translator_type):
        if translator_type == "ollama":
            return self.ollama_translate(text)
        elif translator_type == "openai":
            return self.openai_translate(text)

    def ollama_translate(self, text):
        # Ollama API è°ƒç”¨
        pass

    def openai_translate(self, text):
        # OpenAI API è°ƒç”¨
        pass
```

#### è§†é¢‘å¤„ç†æœåŠ¡ (video.py)

**èŒè´£**: FFmpeg è§†é¢‘å¤„ç†å°è£…

```python
class VideoService:
    def extract_audio(self, video_path):
        """æå–éŸ³é¢‘"""
        cmd = [
            'ffmpeg', '-i', video_path,
            '-vn', '-acodec', 'pcm_s16le',
            '-ar', '16000', '-ac', '1',
            output_path
        ]
        subprocess.run(cmd)

    def merge_subtitles(self, video_path, srt_paths):
        """åµŒå…¥å­—å¹•"""
        cmd = [
            'ffmpeg', '-i', video_path,
            '-i', srt_paths[0],
            '-i', srt_paths[1],
            '-i', srt_paths[2],
            '-map', '0', '-map', '1', '-map', '2', '-map', '3',
            '-c', 'copy',
            output_path
        ]
        subprocess.run(cmd)
```

### 4. å·¥å…·å±‚ (src/utils/)

#### VRAM ç®¡ç†å™¨ (vram_manager.py)

**èŒè´£**: GPU æ˜¾å­˜æ™ºèƒ½è°ƒåº¦

```python
class VRAMManager:
    def switch_to_translation_mode(self):
        """åˆ‡æ¢åˆ°ç¿»è¯‘æ¨¡å¼"""
        # 1. Whisper ç§»è‡³ CPU
        self.whisper_model.to('cpu')

        # 2. æ¸…ç† GPU ç¼“å­˜
        torch.cuda.empty_cache()
        gc.collect()

        # 3. åŠ è½½ Ollama åˆ° GPU
        self.load_ollama_to_gpu()

    def switch_to_transcription_mode(self):
        """åˆ‡æ¢åˆ°è½¬å½•æ¨¡å¼"""
        # 1. å¸è½½ Ollama
        self.unload_ollama()

        # 2. æ¸…ç† GPU ç¼“å­˜
        torch.cuda.empty_cache()
        gc.collect()

        # 3. Whisper ç§»è‡³ GPU
        self.whisper_model.to('cuda')
```

#### è¿›åº¦è·Ÿè¸ªå™¨ (prog_bar/)

**èŒè´£**: å®æ—¶è¿›åº¦è¿½è¸ª

```python
class ProgressTracker:
    def update_progress(self, task_id, status, progress, prog_bar):
        """æ›´æ–°ä»»åŠ¡è¿›åº¦"""
        task = db.get_task(task_id)
        task['status'] = status
        task['progress'] = progress
        task['prog_bar'] = prog_bar
        task['updated_at'] = datetime.now()
        db.save_task(task)
```

---

## å¤„ç†æµç¨‹

### å•ä»»åŠ¡å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant API
    participant TaskMgr
    participant Whisper
    participant Translator
    participant VideoSvc
    participant DB

    User->>API: ä¸Šä¼ è§†é¢‘
    API->>API: éªŒè¯é‚€è¯·ç 
    API->>API: éªŒè¯æ–‡ä»¶
    API->>DB: åˆ›å»ºä»»åŠ¡è®°å½•
    API->>TaskMgr: åŠ å…¥é˜Ÿåˆ—
    API-->>User: è¿”å›ä»»åŠ¡ID

    TaskMgr->>DB: æ›´æ–°çŠ¶æ€: processing
    TaskMgr->>VideoSvc: æå–éŸ³é¢‘
    VideoSvc-->>TaskMgr: éŸ³é¢‘æ–‡ä»¶

    TaskMgr->>DB: æ›´æ–°çŠ¶æ€: æå–åŸæ–‡å­—å¹•
    TaskMgr->>Whisper: è¯­éŸ³è¯†åˆ«
    Whisper-->>TaskMgr: SRT å­—å¹•

    TaskMgr->>DB: æ›´æ–°çŠ¶æ€: ç¿»è¯‘åŸæ–‡å­—å¹•
    TaskMgr->>Translator: ç¿»è¯‘å­—å¹•
    Translator-->>TaskMgr: ç¿»è¯‘å SRT

    alt è§†é¢‘æ¨¡å¼
        TaskMgr->>DB: æ›´æ–°çŠ¶æ€: åˆæˆè§†é¢‘
        TaskMgr->>VideoSvc: åµŒå…¥å­—å¹•
        VideoSvc-->>TaskMgr: æœ€ç»ˆè§†é¢‘
    end

    TaskMgr->>DB: æ›´æ–°çŠ¶æ€: å·²å®Œæˆ
    User->>API: ä¸‹è½½ç»“æœ
    API-->>User: è¿”å›æ–‡ä»¶
```

### VRAM è½®è¯¢æµç¨‹

```mermaid
graph TD
    A[ä»»åŠ¡å¼€å§‹] --> B{æ£€æŸ¥é…ç½®}
    B -->|Ollamaæœ¬åœ°| C[å¯ç”¨VRAMè½®è¯¢]
    B -->|Ollamaè¿œç¨‹/OpenAI| D[ä¸å¯ç”¨è½®è¯¢]

    C --> E[WhisperåŠ è½½åˆ°GPU]
    E --> F[Ollamaå¸è½½]
    F --> G[è¯­éŸ³è¯†åˆ«ASR]

    G --> H[Whisperç§»è‡³CPU]
    H --> I[æ¸…ç†GPUç¼“å­˜]
    I --> J[OllamaåŠ è½½åˆ°GPU]
    J --> K[ç¿»è¯‘]

    K --> L[æ¸…ç†èµ„æº]
    L --> M[ä»»åŠ¡å®Œæˆ]

    D --> N[ä¸¤æ¨¡å‹åŒæ—¶è¿è¡Œ]
    N --> M
```

### æ‰¹é‡å¤„ç†æµç¨‹

```
1. ç”¨æˆ·ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
   â†“
2. åˆ›å»ºæ‰¹æ¬¡è®°å½•
   â”œâ”€ batch_id
   â”œâ”€ total: 5
   â””â”€ sub_tasks: [task1, task2, ...]
   â†“
3. ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºå­ä»»åŠ¡
   â”œâ”€ task1 â†’ é˜Ÿåˆ—
   â”œâ”€ task2 â†’ é˜Ÿåˆ—
   â”œâ”€ task3 â†’ é˜Ÿåˆ—
   â”œâ”€ task4 â†’ é˜Ÿåˆ—
   â””â”€ task5 â†’ é˜Ÿåˆ—
   â†“
4. æŒ‰é¡ºåºå¤„ç†
   â”œâ”€ processing: task1 (others waiting)
   â”œâ”€ completed: task1
   â”œâ”€ processing: task2
   â”œâ”€ completed: task2
   â””â”€ ...
   â†“
5. æ‰€æœ‰ä»»åŠ¡å®Œæˆ
   â†“
6. æ‰“åŒ…ç»“æœä¸º ZIP
   â†“
7. ç”¨æˆ·ä¸‹è½½
```

---

## æ•°æ®æµ

### æ–‡ä»¶æµè½¬

```
1. ä¸Šä¼ é˜¶æ®µ:
   ç”¨æˆ·æ–‡ä»¶ â†’ cache/uploads/{task_id}.mp4

2. å¤„ç†é˜¶æ®µ:
   cache/uploads/{task_id}.mp4
     â†“ (extract_audio)
   cache/temp/{task_id}/audio.wav
     â†“ (transcribe)
   cache/temp/{task_id}/{task_id}_raw.srt
     â†“ (translate)
   cache/temp/{task_id}/{task_id}_translated.srt
   cache/temp/{task_id}/{task_id}_bilingual.srt
     â†“ (merge_video, å¯é€‰)
   cache/temp/{task_id}/{task_id}_final.mp4

3. è¾“å‡ºé˜¶æ®µ:
   cache/temp/{task_id}/*
     â†“ (copy)
   cache/outputs/{task_id}_*.srt
   cache/outputs/{task_id}_final.mp4

4. ä¸‹è½½å:
   cache/outputs/* â†’ (24å°æ—¶ååˆ é™¤)
```

### æ•°æ®åº“ç»“æ„

```json
{
  "single_tasks": {
    "task_id_123": {
      "task_id": "task_id_123",
      "video_path": "cache/uploads/task_id_123.mp4",
      "video_name": "example.mp4",
      "video_duration": 1800.5,
      "mode": "srt",
      "status": "å·²å®Œæˆ",
      "progress": "å®Œæˆ",
      "current_step": "done",
      "prog_bar": 100,
      "batch_id": null,
      "invite_code": "kindmita",
      "created_at": "2025-10-23 10:30:00",
      "updated_at": "2025-10-23 10:45:00",
      "downloaded": false,
      "expired": false,
      "error": null,
      "resume_data": {
        "srt_generated": true,
        "translation_complete": true,
        "video_merged": false
      }
    }
  },
  "batch_tasks": {
    "batch_id_456": {
      "batch_id": "batch_id_456",
      "sub_tasks": {
        "task_1": {...},
        "task_2": {...}
      },
      "status": "å·²å®Œæˆ",
      "progress": "å®Œæˆ",
      "created_at": "2025-10-23 11:00:00",
      "updated_at": "2025-10-23 11:30:00"
    }
  }
}
```

---

## æŠ€æœ¯æ ˆ

### åç«¯

| æŠ€æœ¯ | ç”¨é€” | ç‰ˆæœ¬ |
|------|------|------|
| Flask | Web æ¡†æ¶ | 2.0+ |
| PyTorch | æ·±åº¦å­¦ä¹  | 2.0+ |
| Transformers | æ¨¡å‹åŠ è½½ | 4.30+ |
| FFmpeg | è§†é¢‘å¤„ç† | 4.0+ |
| Requests | HTTP å®¢æˆ·ç«¯ | 2.28+ |

### AI æ¨¡å‹

| æ¨¡å‹ | ç”¨é€” | å¤§å° |
|------|------|------|
| Whisper Large-V3-Turbo | è¯­éŸ³è¯†åˆ« | ~1.5GB |
| Qwen3:8B | ç¿»è¯‘ | ~4.5GB |

### åŸºç¡€è®¾æ–½

| ç»„ä»¶ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| Docker | å®¹å™¨åŒ– | ç»Ÿä¸€éƒ¨ç½²ç¯å¢ƒ |
| Ollama | LLM æ¨ç† | æœ¬åœ°æ¨¡å‹æœåŠ¡ |
| CUDA | GPU åŠ é€Ÿ | 11.0+ |

---

## è®¾è®¡æ¨¡å¼

### 1. å•ä¾‹æ¨¡å¼ (Singleton)

```python
class WhisperService:
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance.model = load_model()
        return cls._instance
```

**åº”ç”¨**: Whisper æ¨¡å‹åŠ è½½ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€å®ä¾‹

### 2. å·¥å‚æ¨¡å¼ (Factory)

```python
class TranslatorFactory:
    @staticmethod
    def create(translator_type):
        if translator_type == "ollama":
            return OllamaTranslator()
        elif translator_type == "openai":
            return OpenAITranslator()
        else:
            raise ValueError("Unknown translator")
```

**åº”ç”¨**: ç¿»è¯‘æœåŠ¡é€‰æ‹©

### 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer)

```python
class ProgressObserver:
    def __init__(self):
        self.listeners = []

    def attach(self, listener):
        self.listeners.append(listener)

    def notify(self, progress):
        for listener in self.listeners:
            listener.update(progress)
```

**åº”ç”¨**: è¿›åº¦è¿½è¸ªå’Œé€šçŸ¥

### 4. ç­–ç•¥æ¨¡å¼ (Strategy)

```python
class VRAMStrategy:
    def execute(self, config):
        if is_local_ollama(config):
            return VRAMPollingStrategy()
        else:
            return NoPollingStrategy()
```

**åº”ç”¨**: VRAM ç®¡ç†ç­–ç•¥é€‰æ‹©

### 5. è´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility)

```python
class SecurityChain:
    def __init__(self):
        self.handlers = [
            FileTypeVerification(),
            RateLimiting(),
            IPBanned(),
            InviteCodeValidation()
        ]

    def process(self, request):
        for handler in self.handlers:
            if not handler.handle(request):
                return False
        return True
```

**åº”ç”¨**: API å®‰å…¨éªŒè¯é“¾

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ˜¾å­˜ä¼˜åŒ–

- **VRAM è½®è¯¢**: 8GB æ˜¾å­˜å³å¯è¿è¡Œ
- **æ¨¡å‹é‡åŒ–**: ä½¿ç”¨ turbo ç‰ˆæœ¬å‡å°‘æ˜¾å­˜
- **æ‰¹å¤„ç†æ§åˆ¶**: é™åˆ¶å¹¶å‘å‡å°‘å†…å­˜å³°å€¼

### 2. å¹¶å‘ä¼˜åŒ–

- **å•ä»»åŠ¡é˜Ÿåˆ—**: é¿å…èµ„æºç«äº‰
- **å¼‚æ­¥ I/O**: æ–‡ä»¶æ“ä½œä½¿ç”¨å¼‚æ­¥
- **çº¿ç¨‹æ± **: é™åˆ¶çº¿ç¨‹æ•°é‡

### 3. ç¼“å­˜ç­–ç•¥

- **24 å°æ—¶è‡ªåŠ¨æ¸…ç†**: é¿å…ç£ç›˜å æ»¡
- **ä¸´æ—¶æ–‡ä»¶å³æ—¶åˆ é™¤**: å¤„ç†å®Œæˆç«‹å³æ¸…ç†
- **æ•°æ®åº“è½»é‡åŒ–**: ä½¿ç”¨ JSON è€Œéé‡å‹æ•°æ®åº“

---

## æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•

```yaml
# docker-compose-cluster.yaml
services:
  tranvideo-1:
    image: tranvideo:latest
    deploy:
      replicas: 3

  nginx:
    image: nginx
    depends_on:
      - tranvideo-1
```

### æ’ä»¶ç³»ç»Ÿ

```python
class TranslatorPlugin:
    def translate(self, text):
        raise NotImplementedError

# ç”¨æˆ·å¯å®ç°è‡ªå®šä¹‰ç¿»è¯‘å™¨
class CustomTranslator(TranslatorPlugin):
    def translate(self, text):
        # è‡ªå®šä¹‰å®ç°
        pass
```

---

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [ä»£ç ç»“æ„](Code-Structure.md) - è¯¦ç»†ä»£ç ç»„ç»‡
- ğŸ”§ [API æ–‡æ¡£](API-Reference.md) - API æ¥å£è®¾è®¡
- ğŸ¯ [æ˜¾å­˜ç®¡ç†](VRAM-Management.md) - VRAM æŠ€æœ¯ç»†èŠ‚
- ğŸ’¡ [æ•…éšœæ’é™¤](Troubleshooting.md) - æ¶æ„ç›¸å…³é—®é¢˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-24
**ç»´æŠ¤è€…**: MitaHill

[è¿”å› Wiki é¦–é¡µ](Home.md)
